<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Frame Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
            padding-bottom: 50px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        header {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 2rem;
        }
        
        .logo h1 {
            font-size: 1.8rem;
        }
        
        /* Main layout */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        /* Upload sections */
        .upload-section {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #182848;
            font-size: 1.3rem;
        }
        
        .section-title i {
            color: #4b6cb7;
        }
        
        .upload-area {
            border: 2px dashed #4b6cb7;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .upload-area:hover {
            background-color: #f0f5ff;
        }
        
        .upload-area i {
            font-size: 3rem;
            color: #4b6cb7;
            margin-bottom: 15px;
        }
        
        .upload-area p {
            margin-bottom: 10px;
        }
        
        .file-count {
            color: #666;
            font-size: 0.9rem;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background: linear-gradient(to right, #4b6cb7, #182848);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(75, 108, 183, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }
        
        /* Editing area */
        .editing-section {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            height: fit-content;
        }
        
        .canvas-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            position: relative;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #mainCanvas {
            max-width: 100%;
            max-height: 100%;
        }
        
        .current-photo-info {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
        }
        
        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .control-group {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .control-group h4 {
            margin-bottom: 12px;
            color: #182848;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .slider-container {
            margin-bottom: 15px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4b6cb7;
            cursor: pointer;
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .filter-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            background-color: #f0f5ff;
        }
        
        .filter-btn.active {
            background-color: #4b6cb7;
            color: white;
            border-color: #4b6cb7;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        /* Photo gallery */
        .photo-gallery {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            margin-top: 30px;
        }
        
        .gallery-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .photo-thumbnail {
            border-radius: 6px;
            overflow: hidden;
            height: 120px;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .photo-thumbnail:hover {
            transform: scale(1.05);
        }
        
        .photo-thumbnail.active {
            border-color: #4b6cb7;
        }
        
        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-index {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        /* Download section */
        .download-section {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            margin-top: 30px;
            text-align: center;
        }
        
        .download-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .download-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
        }
        
        /* Status messages */
        .status-message {
            padding: 12px 15px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4b6cb7;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        /* Frame list */
        .frame-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .frame-item {
            width: 80px;
            height: 80px;
            border: 2px solid #ddd;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .frame-item:hover {
            border-color: #4b6cb7;
        }
        
        .frame-item.active {
            border-color: #4b6cb7;
            border-width: 3px;
        }
        
        .frame-item img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .remove-frame {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff6b6b;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }
        
        .frame-item:hover .remove-frame {
            display: flex;
        }
        
        /* Instructions */
        .instructions {
            background-color: #f0f5ff;
            border-left: 4px solid #4b6cb7;
            padding: 15px;
            border-radius: 0 6px 6px 0;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .instructions h4 {
            margin-bottom: 10px;
            color: #182848;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
    </style>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- JSZip for creating zip files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver.js for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="fas fa-camera-retro"></i>
                <h1>Photo Frame Editor</h1>
            </div>
            <div class="header-info">
                <p>Upload frames and photos, edit, and download all at once!</p>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload sections -->
        <div class="main-content">
            <!-- Frame Upload -->
            <div class="upload-section">
                <div class="section-title">
                    <i class="fas fa-images"></i>
                    <h2>Upload Frame (PNG)</h2>
                </div>
                <div class="upload-area" id="frameUploadArea">
                    <i class="fas fa-file-upload"></i>
                    <p>Drag & drop your PNG frame here or click to browse</p>
                    <p class="file-count">Transparent PNG works best</p>
                    <input type="file" id="frameFile" class="file-input" accept=".png">
                </div>
                <div class="frame-list" id="frameList">
                    <!-- Frames will appear here -->
                </div>
                <p class="instructions">
                    <strong>Tip:</strong> Upload transparent PNG frames. The frame will overlay on your photos.
                </p>
            </div>

            <!-- Photo Upload -->
            <div class="upload-section">
                <div class="section-title">
                    <i class="fas fa-images"></i>
                    <h2>Upload Photos (Max 100)</h2>
                </div>
                <div class="upload-area" id="photoUploadArea">
                    <i class="fas fa-file-upload"></i>
                    <p>Drag & drop your photos here or click to browse</p>
                    <p class="file-count" id="photoCount">0 photos uploaded (max 100)</p>
                    <input type="file" id="photoFiles" class="file-input" accept="image/*" multiple>
                </div>
                <div class="action-buttons">
                    <button class="btn" id="addMorePhotos">
                        <i class="fas fa-plus"></i> Add More Photos
                    </button>
                    <button class="btn btn-secondary" id="clearAllPhotos">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
            </div>
        </div>

        <!-- Editing Area -->
        <div class="editing-section">
            <div class="section-title">
                <i class="fas fa-edit"></i>
                <h2>Edit Photo with Frame</h2>
            </div>
            
            <div class="current-photo-info">
                <div>
                    <span id="currentPhotoIndex">Photo 1 of 0</span>
                    <span id="currentPhotoName"></span>
                </div>
                <div>
                    <button class="btn btn-secondary" id="applyToAll">
                        <i class="fas fa-clone"></i> Apply edits to all photos
                    </button>
                </div>
            </div>
            
            <div class="canvas-container">
                <canvas id="mainCanvas" width="800" height="500"></canvas>
                <div id="noPhotoMessage" style="text-align: center; padding: 20px; display: none;">
                    <i class="fas fa-image" style="font-size: 3rem; color: #ccc; margin-bottom: 15px;"></i>
                    <p>No photo selected. Please upload photos to start editing.</p>
                </div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <h4><i class="fas fa-search"></i> Zoom & Position</h4>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Zoom:</span>
                            <span id="zoomValue">100%</span>
                        </div>
                        <input type="range" min="10" max="300" value="100" class="slider" id="zoomSlider">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Horizontal Position:</span>
                            <span id="positionXValue">0</span>
                        </div>
                        <input type="range" min="-100" max="100" value="0" class="slider" id="positionXSlider">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Vertical Position:</span>
                            <span id="positionYValue">0</span>
                        </div>
                        <input type="range" min="-100" max="100" value="0" class="slider" id="positionYSlider">
                    </div>
                    <button class="btn btn-secondary" id="resetPosition" style="margin-top: 10px;">
                        <i class="fas fa-redo"></i> Reset Position
                    </button>
                </div>
                
                <div class="control-group">
                    <h4><i class="fas fa-filter"></i> Filters</h4>
                    <div class="filter-buttons">
                        <button class="filter-btn" data-filter="none">Normal</button>
                        <button class="filter-btn" data-filter="grayscale">Grayscale</button>
                        <button class="filter-btn" data-filter="sepia">Sepia</button>
                        <button class="filter-btn" data-filter="invert">Invert</button>
                        <button class="filter-btn" data-filter="brightness">Brightness</button>
                        <button class="filter-btn" data-filter="contrast">Contrast</button>
                    </div>
                    <div class="slider-container" id="brightnessContainer" style="display: none;">
                        <div class="slider-label">
                            <span>Brightness:</span>
                            <span id="brightnessValue">100%</span>
                        </div>
                        <input type="range" min="0" max="200" value="100" class="slider" id="brightnessSlider">
                    </div>
                    <div class="slider-container" id="contrastContainer" style="display: none;">
                        <div class="slider-label">
                            <span>Contrast:</span>
                            <span id="contrastValue">100%</span>
                        </div>
                        <input type="range" min="0" max="200" value="100" class="slider" id="contrastSlider">
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn" id="prevPhoto">
                    <i class="fas fa-chevron-left"></i> Previous Photo
                </button>
                <button class="btn" id="nextPhoto">
                    Next Photo <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Photo Gallery -->
        <div class="photo-gallery">
            <div class="gallery-title">
                <div class="section-title">
                    <i class="fas fa-th"></i>
                    <h2>Photo Gallery</h2>
                </div>
                <div id="galleryCount">0 photos</div>
            </div>
            <div class="gallery-grid" id="galleryGrid">
                <!-- Photo thumbnails will appear here -->
            </div>
            <div class="instructions">
                <h4>How to use:</h4>
                <ul>
                    <li>Upload a transparent PNG frame and multiple photos</li>
                    <li>Click on any photo thumbnail to edit it</li>
                    <li>Use zoom, position, and filter controls to customize</li>
                    <li>Apply the same edits to all photos with "Apply to all"</li>
                    <li>Download all edited photos as a ZIP file</li>
                </ul>
            </div>
        </div>

        <!-- Download Section -->
        <div class="download-section">
            <div class="section-title" style="justify-content: center;">
                <i class="fas fa-download"></i>
                <h2>Download All Edited Photos</h2>
            </div>
            <p>Download all your edited photos with frames applied in a single ZIP file.</p>
            <div class="download-options">
                <button class="btn download-btn" id="downloadZip">
                    <i class="fas fa-file-archive"></i> Download as ZIP
                </button>
                <button class="btn download-btn" id="downloadRar">
                    <i class="fas fa-file-archive"></i> Download as RAR (ZIP)
                </button>
            </div>
            <div class="status-message" id="downloadStatus"></div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p style="color: white; font-size: 1.2rem;" id="loadingText">Processing your photos...</p>
    </div>

    <script>
        // Global variables
        let currentFrame = null;
        let currentFrameName = '';
        let photos = [];
        let currentPhotoIndex = 0;
        let frames = [];
        let edits = {};
        let defaultEdit = {
            zoom: 100,
            positionX: 0,
            positionY: 0,
            filter: 'none',
            brightness: 100,
            contrast: 100
        };

        // DOM Elements
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const frameUploadArea = document.getElementById('frameUploadArea');
        const frameFileInput = document.getElementById('frameFile');
        const photoUploadArea = document.getElementById('photoUploadArea');
        const photoFilesInput = document.getElementById('photoFiles');
        const galleryGrid = document.getElementById('galleryGrid');
        const photoCount = document.getElementById('photoCount');
        const galleryCount = document.getElementById('galleryCount');
        const currentPhotoIndexElement = document.getElementById('currentPhotoIndex');
        const currentPhotoNameElement = document.getElementById('currentPhotoName');
        const noPhotoMessage = document.getElementById('noPhotoMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');

        // Control elements
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValue = document.getElementById('zoomValue');
        const positionXSlider = document.getElementById('positionXSlider');
        const positionXValue = document.getElementById('positionXValue');
        const positionYSlider = document.getElementById('positionYSlider');
        const positionYValue = document.getElementById('positionYValue');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const brightnessSlider = document.getElementById('brightnessSlider');
        const brightnessValue = document.getElementById('brightnessValue');
        const contrastSlider = document.getElementById('contrastSlider');
        const contrastValue = document.getElementById('contrastValue');
        const brightnessContainer = document.getElementById('brightnessContainer');
        const contrastContainer = document.getElementById('contrastContainer');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateGallery();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Frame upload
            frameUploadArea.addEventListener('click', () => frameFileInput.click());
            frameFileInput.addEventListener('change', handleFrameUpload);
            
            // Photo upload
            photoUploadArea.addEventListener('click', () => photoFilesInput.click());
            photoFilesInput.addEventListener('change', handlePhotoUpload);
            
            // Add more photos button
            document.getElementById('addMorePhotos').addEventListener('click', () => photoFilesInput.click());
            
            // Clear all photos
            document.getElementById('clearAllPhotos').addEventListener('click', clearAllPhotos);
            
            // Navigation buttons
            document.getElementById('prevPhoto').addEventListener('click', prevPhoto);
            document.getElementById('nextPhoto').addEventListener('click', nextPhoto);
            
            // Apply to all button
            document.getElementById('applyToAll').addEventListener('click', applyEditsToAll);
            
            // Reset position button
            document.getElementById('resetPosition').addEventListener('click', resetPosition);
            
            // Download buttons
            document.getElementById('downloadZip').addEventListener('click', () => downloadAllPhotos('zip'));
            document.getElementById('downloadRar').addEventListener('click', () => downloadAllPhotos('rar'));
            
            // Control sliders
            zoomSlider.addEventListener('input', updateZoom);
            positionXSlider.addEventListener('input', updatePositionX);
            positionYSlider.addEventListener('input', updatePositionY);
            brightnessSlider.addEventListener('input', updateBrightness);
            contrastSlider.addEventListener('input', updateContrast);
            
            // Filter buttons
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    setActiveFilter(this.dataset.filter);
                });
            });
            
            // Drag and drop
            setupDragAndDrop();
        }

        // Handle frame upload
        function handleFrameUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.includes('png')) {
                showStatus('Please upload a PNG file for the frame', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    frames.push({
                        image: img,
                        name: file.name
                    });
                    currentFrame = img;
                    currentFrameName = file.name;
                    updateFrameList();
                    showStatus(`Frame "${file.name}" uploaded successfully`, 'success');
                    renderPhoto();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Handle photo upload
        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            
            // Check total count
            if (photos.length + files.length > 100) {
                showStatus('Maximum 100 photos allowed. Please remove some photos first.', 'error');
                return;
            }
            
            let loadedCount = 0;
            files.forEach((file, index) => {
                if (!file.type.includes('image')) {
                    showStatus(`Skipped ${file.name} - not an image file`, 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const photoId = photos.length;
                        photos.push({
                            id: photoId,
                            image: img,
                            name: file.name,
                            originalWidth: img.width,
                            originalHeight: img.height
                        });
                        
                        // Initialize edits for this photo
                        edits[photoId] = {...defaultEdit};
                        
                        loadedCount++;
                        
                        if (loadedCount === files.length) {
                            updateGallery();
                            showStatus(`${files.length} photo(s) uploaded successfully`, 'success');
                            
                            // If this is the first photo, select it
                            if (photos.length === files.length) {
                                currentPhotoIndex = 0;
                                selectPhoto(0);
                            }
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Update frame list display
        function updateFrameList() {
            const frameList = document.getElementById('frameList');
            frameList.innerHTML = '';
            
            frames.forEach((frame, index) => {
                const frameItem = document.createElement('div');
                frameItem.className = `frame-item ${currentFrame === frame.image ? 'active' : ''}`;
                frameItem.innerHTML = `
                    <img src="${frame.image.src}" alt="${frame.name}">
                    <div class="remove-frame" data-index="${index}">Ã—</div>
                `;
                
                frameItem.addEventListener('click', () => {
                    currentFrame = frame.image;
                    currentFrameName = frame.name;
                    updateFrameList();
                    renderPhoto();
                });
                
                const removeBtn = frameItem.querySelector('.remove-frame');
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    frames.splice(index, 1);
                    if (currentFrame === frame.image) {
                        currentFrame = frames.length > 0 ? frames[0].image : null;
                        currentFrameName = frames.length > 0 ? frames[0].name : '';
                    }
                    updateFrameList();
                    renderPhoto();
                });
                
                frameList.appendChild(frameItem);
            });
        }

        // Update gallery display
        function updateGallery() {
            galleryGrid.innerHTML = '';
            
            if (photos.length === 0) {
                noPhotoMessage.style.display = 'block';
                canvas.style.display = 'none';
                photoCount.textContent = '0 photos uploaded (max 100)';
                galleryCount.textContent = '0 photos';
                currentPhotoIndexElement.textContent = 'Photo 1 of 0';
                currentPhotoNameElement.textContent = '';
                return;
            }
            
            noPhotoMessage.style.display = 'none';
            canvas.style.display = 'block';
            photoCount.textContent = `${photos.length} photos uploaded (max 100)`;
            galleryCount.textContent = `${photos.length} photos`;
            
            photos.forEach((photo, index) => {
                const thumbnail = document.createElement('div');
                thumbnail.className = `photo-thumbnail ${index === currentPhotoIndex ? 'active' : ''}`;
                
                // Create a thumbnail image
                const thumbnailCanvas = document.createElement('canvas');
                const thumbnailCtx = thumbnailCanvas.getContext('2d');
                thumbnailCanvas.width = 120;
                thumbnailCanvas.height = 120;
                
                // Draw the photo on thumbnail canvas
                const scale = Math.min(
                    thumbnailCanvas.width / photo.image.width,
                    thumbnailCanvas.height / photo.image.height
                );
                const x = (thumbnailCanvas.width - photo.image.width * scale) / 2;
                const y = (thumbnailCanvas.height - photo.image.height * scale) / 2;
                
                thumbnailCtx.drawImage(
                    photo.image, 
                    x, y, 
                    photo.image.width * scale, 
                    photo.image.height * scale
                );
                
                thumbnail.innerHTML = `
                    <img src="${thumbnailCanvas.toDataURL()}" alt="Thumbnail">
                    <div class="photo-index">${index + 1}</div>
                `;
                
                thumbnail.addEventListener('click', () => selectPhoto(index));
                galleryGrid.appendChild(thumbnail);
            });
            
            updateCurrentPhotoInfo();
        }

        // Select a photo for editing
        function selectPhoto(index) {
            if (index < 0 || index >= photos.length) return;
            
            // Update active thumbnail
            document.querySelectorAll('.photo-thumbnail').forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
            
            currentPhotoIndex = index;
            updateCurrentPhotoInfo();
            loadPhotoEdits();
            renderPhoto();
        }

        // Update current photo info display
        function updateCurrentPhotoInfo() {
            if (photos.length === 0) return;
            
            const photo = photos[currentPhotoIndex];
            currentPhotoIndexElement.textContent = `Photo ${currentPhotoIndex + 1} of ${photos.length}`;
            currentPhotoNameElement.textContent = ` - ${photo.name}`;
        }

        // Load edits for current photo
        function loadPhotoEdits() {
            if (!edits[currentPhotoIndex]) {
                edits[currentPhotoIndex] = {...defaultEdit};
            }
            
            const edit = edits[currentPhotoIndex];
            
            // Update sliders and values
            zoomSlider.value = edit.zoom;
            zoomValue.textContent = `${edit.zoom}%`;
            
            positionXSlider.value = edit.positionX;
            positionXValue.textContent = edit.positionX;
            
            positionYSlider.value = edit.positionY;
            positionYValue.textContent = edit.positionY;
            
            brightnessSlider.value = edit.brightness;
            brightnessValue.textContent = `${edit.brightness}%`;
            
            contrastSlider.value = edit.contrast;
            contrastValue.textContent = `${edit.contrast}%`;
            
            // Update filter buttons
            filterButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === edit.filter);
            });
            
            // Show/hide brightness/contrast sliders
            brightnessContainer.style.display = edit.filter === 'brightness' ? 'block' : 'none';
            contrastContainer.style.display = edit.filter === 'contrast' ? 'block' : 'none';
        }

        // Render photo with frame and edits
        function renderPhoto() {
            if (photos.length === 0 || !photos[currentPhotoIndex]) {
                return;
            }
            
            const photo = photos[currentPhotoIndex];
            const edit = edits[currentPhotoIndex];
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Calculate dimensions for the photo
            const zoom = edit.zoom / 100;
            const photoWidth = photo.image.width * zoom;
            const photoHeight = photo.image.height * zoom;
            
            // Center the photo on canvas with position offset
            const offsetX = (edit.positionX / 100) * (canvas.width / 2);
            const offsetY = (edit.positionY / 100) * (canvas.height / 2);
            const photoX = (canvas.width - photoWidth) / 2 + offsetX;
            const photoY = (canvas.height - photoHeight) / 2 + offsetY;
            
            // Apply filters
            let filterString = '';
            if (edit.filter === 'grayscale') {
                filterString = 'grayscale(100%)';
            } else if (edit.filter === 'sepia') {
                filterString = 'sepia(100%)';
            } else if (edit.filter === 'invert') {
                filterString = 'invert(100%)';
            } else if (edit.filter === 'brightness') {
                filterString = `brightness(${edit.brightness}%)`;
            } else if (edit.filter === 'contrast') {
                filterString = `contrast(${edit.contrast}%)`;
            }
            
            // Save context state
            ctx.save();
            
            // Apply filter
            if (filterString) {
                ctx.filter = filterString;
            }
            
            // Draw the photo
            ctx.drawImage(photo.image, photoX, photoY, photoWidth, photoHeight);
            
            // Restore context (remove filter for frame)
            ctx.restore();
            
            // Draw frame if available
            if (currentFrame) {
                // Draw frame to cover the entire canvas
                ctx.drawImage(currentFrame, 0, 0, canvas.width, canvas.height);
            }
        }

        // Update zoom
        function updateZoom() {
            const zoom = parseInt(zoomSlider.value);
            zoomValue.textContent = `${zoom}%`;
            
            if (photos.length > 0) {
                edits[currentPhotoIndex].zoom = zoom;
                renderPhoto();
            }
        }

        // Update horizontal position
        function updatePositionX() {
            const position = parseInt(positionXSlider.value);
            positionXValue.textContent = position;
            
            if (photos.length > 0) {
                edits[currentPhotoIndex].positionX = position;
                renderPhoto();
            }
        }

        // Update vertical position
        function updatePositionY() {
            const position = parseInt(positionYSlider.value);
            positionYValue.textContent = position;
            
            if (photos.length > 0) {
                edits[currentPhotoIndex].positionY = position;
                renderPhoto();
            }
        }

        // Update brightness
        function updateBrightness() {
            const brightness = parseInt(brightnessSlider.value);
            brightnessValue.textContent = `${brightness}%`;
            
            if (photos.length > 0) {
                edits[currentPhotoIndex].brightness = brightness;
                renderPhoto();
            }
        }

        // Update contrast
        function updateContrast() {
            const contrast = parseInt(contrastSlider.value);
            contrastValue.textContent = `${contrast}%`;
            
            if (photos.length > 0) {
                edits[currentPhotoIndex].contrast = contrast;
                renderPhoto();
            }
        }

        // Set active filter
        function setActiveFilter(filter) {
            if (photos.length === 0) return;
            
            // Update filter buttons
            filterButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            
            // Update edit
            edits[currentPhotoIndex].filter = filter;
            
            // Show/hide brightness/contrast sliders
            brightnessContainer.style.display = filter === 'brightness' ? 'block' : 'none';
            contrastContainer.style.display = filter === 'contrast' ? 'block' : 'none';
            
            renderPhoto();
        }

        // Reset position
        function resetPosition() {
            if (photos.length === 0) return;
            
            edits[currentPhotoIndex].positionX = 0;
            edits[currentPhotoIndex].positionY = 0;
            edits[currentPhotoIndex].zoom = 100;
            
            positionXSlider.value = 0;
            positionXValue.textContent = '0';
            positionYSlider.value = 0;
            positionYValue.textContent = '0';
            zoomSlider.value = 100;
            zoomValue.textContent = '100%';
            
            renderPhoto();
        }

        // Apply edits to all photos
        function applyEditsToAll() {
            if (photos.length === 0) return;
            
            if (!confirm(`Apply current edits to all ${photos.length} photos?`)) {
                return;
            }
            
            const currentEdit = {...edits[currentPhotoIndex]};
            
            photos.forEach((photo, index) => {
                edits[index] = {...currentEdit};
            });
            
            showStatus(`Edits applied to all ${photos.length} photos`, 'success');
        }

        // Navigate to previous photo
        function prevPhoto() {
            if (photos.length === 0) return;
            
            let newIndex = currentPhotoIndex - 1;
            if (newIndex < 0) newIndex = photos.length - 1;
            selectPhoto(newIndex);
        }

        // Navigate to next photo
        function nextPhoto() {
            if (photos.length === 0) return;
            
            let newIndex = currentPhotoIndex + 1;
            if (newIndex >= photos.length) newIndex = 0;
            selectPhoto(newIndex);
        }

        // Clear all photos
        function clearAllPhotos() {
            if (photos.length === 0) return;
            
            if (!confirm(`Clear all ${photos.length} photos?`)) {
                return;
            }
            
            photos = [];
            edits = {};
            currentPhotoIndex = 0;
            updateGallery();
            showStatus('All photos cleared', 'success');
        }

        // Download all photos
        async function downloadAllPhotos(format) {
            if (photos.length === 0) {
                showStatus('No photos to download', 'error');
                return;
            }
            
            if (format === 'rar') {
                showStatus('RAR format not supported in browser. Downloading as ZIP instead.', 'success');
                format = 'zip';
            }
            
            loadingText.textContent = 'Processing your photos...';
            loadingOverlay.style.display = 'flex';
            
            try {
                const zip = new JSZip();
                
                // Process each photo
                for (let i = 0; i < photos.length; i++) {
                    const photo = photos[i];
                    const edit = edits[i];
                    
                    // Create a temporary canvas to render the edited photo
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    // Use original photo dimensions or scaled down for performance
                    const maxDimension = 2000;
                    let width = photo.originalWidth;
                    let height = photo.originalHeight;
                    
                    if (width > maxDimension || height > maxDimension) {
                        const scale = maxDimension / Math.max(width, height);
                        width = Math.floor(width * scale);
                        height = Math.floor(height * scale);
                    }
                    
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    
                    // Apply zoom
                    const zoom = edit.zoom / 100;
                    const photoWidth = width * zoom;
                    const photoHeight = height * zoom;
                    
                    // Apply position offset
                    const offsetX = (edit.positionX / 100) * (width / 2);
                    const offsetY = (edit.positionY / 100) * (height / 2);
                    const photoX = (width - photoWidth) / 2 + offsetX;
                    const photoY = (height - photoHeight) / 2 + offsetY;
                    
                    // Apply filter
                    let filterString = '';
                    if (edit.filter === 'grayscale') {
                        filterString = 'grayscale(100%)';
                    } else if (edit.filter === 'sepia') {
                        filterString = 'sepia(100%)';
                    } else if (edit.filter === 'invert') {
                        filterString = 'invert(100%)';
                    } else if (edit.filter === 'brightness') {
                        filterString = `brightness(${edit.brightness}%)`;
                    } else if (edit.filter === 'contrast') {
                        filterString = `contrast(${edit.contrast}%)`;
                    }
                    
                    // Draw the photo with filter
                    tempCtx.save();
                    if (filterString) {
                        tempCtx.filter = filterString;
                    }
                    tempCtx.drawImage(photo.image, photoX, photoY, photoWidth, photoHeight);
                    tempCtx.restore();
                    
                    // Draw frame if available
                    if (currentFrame) {
                        tempCtx.drawImage(currentFrame, 0, 0, width, height);
                    }
                    
                    // Convert to blob and add to zip
                    const blob = await new Promise(resolve => {
                        tempCanvas.toBlob(resolve, 'image/jpeg', 0.9);
                    });
                    
                    // Clean up file name
                    const fileName = photo.name.replace(/\.[^/.]+$/, "") || `photo_${i+1}`;
                    zip.file(`${fileName}_edited.jpg`, blob);
                    
                    // Update loading text
                    loadingText.textContent = `Processing photo ${i+1} of ${photos.length}...`;
                }
                
                // Generate zip file
                const zipBlob = await zip.generateAsync({type: 'blob'});
                
                // Save the zip file
                const fileName = `edited_photos_${new Date().getTime()}.zip`;
                saveAs(zipBlob, fileName);
                
                showStatus(`Downloaded ${photos.length} photos as ${fileName}`, 'success');
            } catch (error) {
                console.error('Error creating zip:', error);
                showStatus('Error creating download file', 'error');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // Setup drag and drop
        function setupDragAndDrop() {
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                frameUploadArea.addEventListener(eventName, preventDefaults, false);
                photoUploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // Highlight drop area when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                frameUploadArea.addEventListener(eventName, highlight, false);
                photoUploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                frameUploadArea.addEventListener(eventName, unhighlight, false);
                photoUploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            // Handle dropped files
            frameUploadArea.addEventListener('drop', handleFrameDrop, false);
            photoUploadArea.addEventListener('drop', handlePhotoDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight(e) {
                e.currentTarget.style.backgroundColor = '#f0f5ff';
                e.currentTarget.style.borderColor = '#4b6cb7';
            }
            
            function unhighlight(e) {
                e.currentTarget.style.backgroundColor = '';
                e.currentTarget.style.borderColor = '#4b6cb7';
            }
            
            function handleFrameDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    const file = files[0];
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    frameFileInput.files = dataTransfer.files;
                    
                    // Trigger the change event
                    const event = new Event('change', { bubbles: true });
                    frameFileInput.dispatchEvent(event);
                }
            }
            
            function handlePhotoDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    const dataTransfer = new DataTransfer();
                    for (let i = 0; i < Math.min(files.length, 100); i++) {
                        dataTransfer.items.add(files[i]);
                    }
                    photoFilesInput.files = dataTransfer.files;
                    
                    // Trigger the change event
                    const event = new Event('change', { bubbles: true });
                    photoFilesInput.dispatchEvent(event);
                }
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusElement = document.getElementById('downloadStatus');
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>